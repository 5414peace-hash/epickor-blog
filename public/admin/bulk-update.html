<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bulk Manager - EpicKor Blog Admin</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #f5f5f5;
      padding: 2rem;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      padding: 2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    h1 {
      color: #2C2416;
      margin-bottom: 1rem;
      font-size: 2rem;
    }
    
    .description {
      color: #666;
      margin-bottom: 2rem;
      line-height: 1.6;
    }
    
    .upload-area {
      border: 3px dashed #E85A4F;
      border-radius: 8px;
      padding: 3rem;
      text-align: center;
      background-color: #FAF6F0;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .upload-area:hover {
      background-color: #f0ebe5;
      border-color: #D4A574;
    }
    
    .upload-area.dragover {
      background-color: #e8e3dd;
      border-color: #5B7B6F;
    }
    
    .upload-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    
    .upload-text {
      font-size: 1.2rem;
      color: #2C2416;
      margin-bottom: 0.5rem;
    }
    
    .upload-hint {
      color: #666;
      font-size: 0.9rem;
    }
    
    #fileInput {
      display: none;
    }
    
    .file-list {
      margin-top: 2rem;
    }
    
    .file-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      background-color: #f9f9f9;
      border-radius: 4px;
      margin-bottom: 0.5rem;
    }
    
    .file-name {
      flex: 1;
      font-weight: 500;
    }
    
    .file-status {
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    .status-pending {
      background-color: #FFF3CD;
      color: #856404;
    }
    
    .status-success {
      background-color: #D4EDDA;
      color: #155724;
    }
    
    .status-error {
      background-color: #F8D7DA;
      color: #721C24;
    }
    
    .actions {
      margin-top: 2rem;
      display: flex;
      gap: 1rem;
    }
    
    button {
      padding: 0.75rem 2rem;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .btn-primary {
      background-color: #E85A4F;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #d14a3f;
    }
    
    .btn-primary:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background-color: #5B7B6F;
      color: white;
    }
    
    .btn-secondary:hover {
      background-color: #4a6a5f;
    }
    
    .progress {
      margin-top: 2rem;
      display: none;
    }
    
    .progress-bar {
      width: 100%;
      height: 30px;
      background-color: #e0e0e0;
      border-radius: 15px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background-color: #5B7B6F;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 500;
    }
    
    .results {
      margin-top: 2rem;
      display: none;
    }
    
    .result-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .result-card {
      padding: 1.5rem;
      border-radius: 8px;
      text-align: center;
    }
    
    .result-card h3 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    
    .result-card p {
      color: #666;
      font-size: 0.9rem;
    }
    
    .card-success {
      background-color: #D4EDDA;
      color: #155724;
    }
    
    .card-error {
      background-color: #F8D7DA;
      color: #721C24;
    }
    
    .card-skipped {
      background-color: #FFF3CD;
      color: #856404;
    }

    .log-area {
      margin-top: 1rem;
      padding: 1rem;
      background-color: #f9f9f9;
      border-radius: 4px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
    }

    .log-entry {
      margin-bottom: 0.5rem;
      padding: 0.25rem;
    }

    .log-info {
      color: #0066cc;
    }

    .log-success {
      color: #155724;
      font-weight: 500;
    }

    .log-error {
      color: #721C24;
      font-weight: 500;
    }

    .deployment-notice {
      margin-top: 1rem;
      padding: 1rem;
      background-color: #D1ECF1;
      border-left: 4px solid #0C5460;
      border-radius: 4px;
      color: #0C5460;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üì¶ Bulk Manager</h1>
    <p class="description">
      Upload multiple markdown files to update existing blog posts. 
      File names like "001-title.md" or "001.md" will be matched by the 3-digit number.
    </p>
    
    <div class="upload-area" id="uploadArea">
      <div class="upload-icon">üìÅ</div>
      <div class="upload-text">Click to select files or drag & drop here</div>
      <div class="upload-hint">Supports multiple .md files (e.g., 001.md, 001-title.md)</div>
    </div>
    
    <input type="file" id="fileInput" multiple accept=".md,.markdown" />
    
    <div class="file-list" id="fileList"></div>
    
    <div class="actions">
      <button class="btn-primary" id="processBtn" disabled>Process Files</button>
      <button class="btn-secondary" id="clearBtn">Clear All</button>
      <a href="/admin" style="margin-left: auto;">
        <button class="btn-secondary">Back to Admin</button>
      </a>
    </div>
    
    <div class="progress" id="progress">
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill">0%</div>
      </div>
    </div>

    <div class="deployment-notice" id="deploymentNotice">
      ‚úÖ <strong>GitHubÏóê Î∞òÏòÅÎêòÏóàÏäµÎãàÎã§!</strong> Vercel Î∞∞Ìè¨ ÏôÑÎ£åÍπåÏßÄ ÏïΩ 2Î∂Ñ Ï†ïÎèÑ Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.
    </div>
    
    <div class="results" id="results">
      <h2>Results</h2>
      <div class="result-summary">
        <div class="result-card card-success">
          <h3 id="successCount">0</h3>
          <p>Successfully Updated</p>
        </div>
        <div class="result-card card-error">
          <h3 id="errorCount">0</h3>
          <p>Failed</p>
        </div>
        <div class="result-card card-skipped">
          <h3 id="skippedCount">0</h3>
          <p>Skipped</p>
        </div>
      </div>
      <div class="log-area" id="logArea"></div>
    </div>
  </div>
  
  <script>
    let selectedFiles = [];
    
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const processBtn = document.getElementById('processBtn');
    const clearBtn = document.getElementById('clearBtn');
    const progress = document.getElementById('progress');
    const progressFill = document.getElementById('progressFill');
    const results = document.getElementById('results');
    const logArea = document.getElementById('logArea');
    const deploymentNotice = document.getElementById('deploymentNotice');
    
    // Logging function
    function log(message, type = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logArea.appendChild(entry);
      logArea.scrollTop = logArea.scrollHeight;
      console.log(`[Bulk Manager] ${message}`);
    }

    // Click to select files
    uploadArea.addEventListener('click', () => {
      fileInput.click();
    });
    
    // File input change
    fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });
    
    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      handleFiles(e.dataTransfer.files);
    });
    
    function handleFiles(files) {
      selectedFiles = Array.from(files).filter(f => 
        f.name.endsWith('.md') || f.name.endsWith('.markdown')
      );
      
      renderFileList();
      processBtn.disabled = selectedFiles.length === 0;
    }
    
    function renderFileList() {
      if (selectedFiles.length === 0) {
        fileList.innerHTML = '';
        return;
      }
      
      fileList.innerHTML = '<h3>Selected Files:</h3>';
      selectedFiles.forEach(file => {
        const item = document.createElement('div');
        item.className = 'file-item';
        item.innerHTML = `
          <span class="file-name">${file.name}</span>
          <span class="file-status status-pending">Pending</span>
        `;
        fileList.appendChild(item);
      });
    }
    
    clearBtn.addEventListener('click', () => {
      selectedFiles = [];
      fileInput.value = '';
      renderFileList();
      processBtn.disabled = true;
      progress.style.display = 'none';
      results.style.display = 'none';
      deploymentNotice.style.display = 'none';
    });
    
    processBtn.addEventListener('click', async () => {
      processBtn.disabled = true;
      progress.style.display = 'block';
      results.style.display = 'block';
      logArea.innerHTML = '';
      deploymentNotice.style.display = 'none';
      
      let successCount = 0;
      let errorCount = 0;
      let skippedCount = 0;
      
      log('Starting bulk update process...', 'info');
      
      for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];
        const fileItems = fileList.querySelectorAll('.file-item');
        const currentItem = fileItems[i];
        
        try {
          log(`Processing: ${file.name}`, 'info');
          const content = await file.text();
          const result = await processFile(content, file.name);
          
          if (result.success) {
            successCount++;
            currentItem.querySelector('.file-status').className = 'file-status status-success';
            currentItem.querySelector('.file-status').textContent = 'Success';
            log(`‚úì ${file.name} - Success (Slug: ${result.slug})`, 'success');
          } else if (result.skipped) {
            skippedCount++;
            currentItem.querySelector('.file-status').className = 'file-status status-pending';
            currentItem.querySelector('.file-status').textContent = 'Skipped';
            log(`‚äò ${file.name} - Skipped: ${result.reason}`, 'info');
          } else {
            errorCount++;
            currentItem.querySelector('.file-status').className = 'file-status status-error';
            currentItem.querySelector('.file-status').textContent = 'Error';
            log(`‚úó ${file.name} - Error: ${result.reason}`, 'error');
          }
        } catch (error) {
          errorCount++;
          currentItem.querySelector('.file-status').className = 'file-status status-error';
          currentItem.querySelector('.file-status').textContent = 'Error';
          log(`‚úó ${file.name} - Exception: ${error.message}`, 'error');
        }
        
        const percent = Math.round(((i + 1) / selectedFiles.length) * 100);
        progressFill.style.width = percent + '%';
        progressFill.textContent = percent + '%';
      }
      
      // Show results
      document.getElementById('successCount').textContent = successCount;
      document.getElementById('errorCount').textContent = errorCount;
      document.getElementById('skippedCount').textContent = skippedCount;
      
      if (successCount > 0) {
        deploymentNotice.style.display = 'block';
        log(`Bulk update completed: ${successCount} success, ${errorCount} failed, ${skippedCount} skipped`, 'success');
      } else {
        log(`Bulk update completed with no successful commits`, 'info');
      }
      
      processBtn.disabled = false;
    });
    
    // Extract 3-digit number from filename
    function extractSlugFromFilename(filename) {
      // Match patterns like: 001.md, 001-title.md, 001-some-long-title.md
      const match = filename.match(/^(\d{3})/);
      if (match) {
        return match[1];
      }
      return null;
    }

    async function processFile(content, filename) {
      // Extract frontmatter and body
      const match = content.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
      if (!match) {
        return { success: false, reason: 'Invalid markdown format (no frontmatter)' };
      }
      
      const frontmatter = match[1];
      const newBody = match[2];
      
      // Extract slug from filename (001-title.md ‚Üí 001)
      const slugFromFilename = extractSlugFromFilename(filename);
      if (!slugFromFilename) {
        return { 
          success: false, 
          reason: 'ÌååÏùºÎ™Ö Îß§Ïπ≠ Ïã§Ìå®: 001.md ÎòêÎäî 001-title.md ÌòïÏãùÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî' 
        };
      }
      
      log(`Extracted slug from filename: ${slugFromFilename}`, 'info');
      
      // Try to get GitHub token from Decap CMS
      // Decap CMS v3.0.0 uses 'decap-cms-user', older versions use 'netlify-cms-user'
      let token = localStorage.getItem('decap-cms-user');
      if (!token) {
        token = localStorage.getItem('netlify-cms-user'); // Fallback to old key
      }
      
      if (!token) {
        log('GitHub token not found in localStorage', 'error');
        log('Available keys: ' + Object.keys(localStorage).join(', '), 'info');
        return { 
          success: false, 
          reason: 'GitHub token not found. Please login to Decap CMS first.' 
        };
      }

      let parsedToken;
      try {
        parsedToken = JSON.parse(token);
        log('Token parsed successfully', 'info');
        log('Token structure: ' + JSON.stringify(Object.keys(parsedToken)), 'info');
      } catch (e) {
        log('Failed to parse token: ' + e.message, 'error');
        return { 
          success: false, 
          reason: 'Invalid token format' 
        };
      }

      // Decap CMS stores token in backend.token path
      const githubToken = parsedToken.backend?.token || parsedToken.token;
      if (!githubToken) {
        log('GitHub token missing. Token structure: ' + JSON.stringify(parsedToken, null, 2), 'error');
        return { 
          success: false, 
          reason: 'GitHub token missing in stored credentials' 
        };
      }
      
      log('GitHub token found: ' + githubToken.substring(0, 10) + '...', 'success');
      
      // Find existing file in GitHub
      const owner = 'epickor';
      const repo = 'epickor-blog';
      const branch = 'main';
      
      try {
        // List files in content/blog/
        log(`Searching for existing file with slug ${slugFromFilename}...`, 'info');
        const listResponse = await fetch(
          `https://api.github.com/repos/${owner}/${repo}/contents/content/blog?ref=${branch}`,
          {
            headers: {
              'Authorization': `token ${githubToken}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          }
        );

        if (!listResponse.ok) {
          log(`GitHub API Error: ${listResponse.status} ${listResponse.statusText}`, 'error');
          return { 
            success: false, 
            reason: `GitHub API error: ${listResponse.status}` 
          };
        }

        const files = await listResponse.json();
        log(`Found ${files.length} files in content/blog/`, 'info');
        
        // Find file that starts with slug
        const existingFile = files.find(f => f.name.startsWith(slugFromFilename));
        
        if (!existingFile) {
          return { 
            success: false, 
            reason: `No existing file found with slug ${slugFromFilename}` 
          };
        }

        log(`Found existing file: ${existingFile.name}`, 'info');
        
        // Get file content to get SHA
        const fileResponse = await fetch(existingFile.url, {
          headers: {
            'Authorization': `token ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        if (!fileResponse.ok) {
          log(`Failed to fetch file details: ${fileResponse.status}`, 'error');
          return { 
            success: false, 
            reason: `Failed to fetch file: ${fileResponse.status}` 
          };
        }

        const fileData = await fileResponse.json();
        const sha = fileData.sha;
        
        // Update file
        log(`Updating file with SHA: ${sha.substring(0, 7)}...`, 'info');
        const updateResponse = await fetch(
          `https://api.github.com/repos/${owner}/${repo}/contents/${existingFile.path}`,
          {
            method: 'PUT',
            headers: {
              'Authorization': `token ${githubToken}`,
              'Accept': 'application/vnd.github.v3+json',
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              message: `Update ${existingFile.name} via Bulk Manager`,
              content: btoa(unescape(encodeURIComponent(content))),
              sha: sha,
              branch: branch
            })
          }
        );

        const updateData = await updateResponse.json();
        
        if (updateResponse.ok && (updateResponse.status === 200 || updateResponse.status === 201)) {
          log(`GitHub API Response: ${updateResponse.status} ${updateResponse.statusText}`, 'success');
          log(`Commit SHA: ${updateData.commit.sha.substring(0, 7)}`, 'success');
          return { 
            success: true, 
            slug: slugFromFilename,
            commitSha: updateData.commit.sha
          };
        } else {
          log(`GitHub API Error: ${updateResponse.status} - ${JSON.stringify(updateData)}`, 'error');
          return { 
            success: false, 
            reason: `GitHub update failed: ${updateResponse.status}` 
          };
        }
        
      } catch (error) {
        log(`Exception during GitHub API call: ${error.message}`, 'error');
        return { 
          success: false, 
          reason: `Network error: ${error.message}` 
        };
      }
    }
  </script>
</body>
</html>
